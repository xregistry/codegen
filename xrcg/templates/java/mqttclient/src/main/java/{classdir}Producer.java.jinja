{%- import 'util.jinja.include' as util -%}
{%- import 'cloudevents.jinja.include' as cloudEvents -%}
{%- import 'mqtt.jinja.include' as mqtt -%}
{{ util.CommonFileHeader() }}

{%- set messagegroups = root.messagegroups %}
{%- set package_name = project_name | lower | replace('-', '_') %}

{% for messagegroupid, messagegroup in messagegroups.items() -%}
{%- set groupname = messagegroupid | pascal -%}
{%- set group_package = (package_name ~ "." ~ messagegroupid) | lower | replace('-', '_') %}
package {{ group_package }};

import java.util.HashMap;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import org.eclipse.paho.client.mqttv3.*;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

{%- for messageid, message in messagegroup.messages.items() %}
{%- set message_body_type = util.get_data_type(data_project_name, root, message) %}
{%- if '.' in message_body_type %}
import {{ message_body_type.rsplit('.', 1)[0] }}.*;
{%- endif %}
{%- endfor %}

{%- set producer_class = (groupname | strip_namespace) ~ 'Producer' %}

{#- Helper macro to get the default topic for a message -#}
{%- macro get_default_topic(message, messageid) -%}
{%- if message.protocoloptions and message.protocoloptions.properties and message.protocoloptions.properties.topic -%}
{{ message.protocoloptions.properties.topic.value }}
{%- elif message.binding and message.binding.mqtt and message.binding.mqtt.topic -%}
{{ message.binding.mqtt.topic }}
{%- elif message.metadata and message.metadata.attributes and message.metadata.attributes["topic-name"] -%}
{{ message.metadata.attributes["topic-name"].value }}
{%- else -%}
{{ messageid }}
{%- endif -%}
{%- endmacro -%}

/**
 * MQTT Producer for {{ messagegroupid }} message group.
 */
public class {{ producer_class }} implements AutoCloseable {
    private static final Logger logger = LogManager.getLogger({{ producer_class }}.class);
    private static final Pattern URI_TEMPLATE_PATTERN = Pattern.compile("\\{([A-Za-z0-9_]+)\\}");
    
    private final MqttClient mqttClient;
    private final Map<String, String> topicMappings;

    /**
     * Creates a new producer with default topic mappings.
     * 
     * @param mqttClient The MQTT client to use for publishing
     */
    public {{ producer_class }}(MqttClient mqttClient) {
        this(mqttClient, null);
    }

    /**
     * Creates a new producer with custom topic mappings.
     * 
     * @param mqttClient The MQTT client to use for publishing
     * @param topicMappings Optional map of message identifiers to topic patterns.
     *                      Topic patterns may be URI templates with placeholders like {placeholder}.
     *                      If null, uses default 1:1 mapping.
     */
    public {{ producer_class }}(MqttClient mqttClient, Map<String, String> topicMappings) {
        this.mqttClient = mqttClient;
        this.topicMappings = topicMappings != null ? new HashMap<>(topicMappings) : getDefaultTopicMappings();
    }

    /**
     * Gets the default topic mappings for all messages in this group.
     * 
     * @return A map of message identifiers to their default topic patterns
     */
    public static Map<String, String> getDefaultTopicMappings() {
        Map<String, String> mappings = new HashMap<>();
        {%- for messageid, message in messagegroup.messages.items() %}
        mappings.put("{{ messageid }}", "{{ get_default_topic(message, messageid) }}");
        {%- endfor %}
        return mappings;
    }

    /**
     * Gets the current topic mappings.
     * 
     * @return A copy of the current topic mappings
     */
    public Map<String, String> getTopicMappings() {
        return new HashMap<>(topicMappings);
    }

    /**
     * Applies URI template values to a topic pattern.
     * 
     * @param topicPattern The topic pattern with placeholders like {placeholder}
     * @param templateValues Map of placeholder names to values
     * @return The topic with placeholders replaced by values
     */
    private static String applyTopicTemplate(String topicPattern, Map<String, String> templateValues) {
        if (templateValues == null || templateValues.isEmpty()) {
            return topicPattern;
        }
        String result = topicPattern;
        Matcher matcher = URI_TEMPLATE_PATTERN.matcher(topicPattern);
        StringBuffer sb = new StringBuffer();
        while (matcher.find()) {
            String placeholder = matcher.group(1);
            String value = templateValues.get(placeholder);
            matcher.appendReplacement(sb, value != null ? Matcher.quoteReplacement(value) : matcher.group(0));
        }
        matcher.appendTail(sb);
        return sb.toString();
    }

    {%- for messageid, message in messagegroup.messages.items() %}
    {%- set messagename = messageid | pascal | strip_namespace %}
    {%- set message_body_type = util.get_data_type(data_project_name, root, message) %}
    {%- set default_topic = get_default_topic(message, messageid) %}
    {%- set topic_template_vars = [] %}
    {%- if message.protocoloptions and message.protocoloptions.properties and message.protocoloptions.properties.topic and message.protocoloptions.properties.topic.type == "uritemplate" %}
        {%- set topic_phs = message.protocoloptions.properties.topic.value | regex_search('\\{([A-Za-z0-9_]+)\\}') %}
        {%- if topic_phs %}
            {%- for placeholder in topic_phs %}
                {%- if placeholder not in topic_template_vars %}
                    {%- set _ = topic_template_vars.append(placeholder) %}
                {%- endif %}
            {%- endfor %}
        {%- endif %}
    {%- endif %}

    /**
     * Send {{ messagename }} message to MQTT topic.
     * 
     * @param data The message data to send
     {%- for var in topic_template_vars %}
     * @param {{ var }} Topic template placeholder value
     {%- endfor %}
     * @param topicTemplateValues Optional additional topic template values
     * @param qos Quality of Service (0, 1, or 2)
     * @throws MqttException if publishing fails
     {%- if message_body_type != "byte[]" %}
     * @throws Exception if serialization fails
     {%- endif %}
     */
    public void send{{ messagename }}({{ message_body_type }} data
        {%- for var in topic_template_vars %}, String {{ var }}{%- endfor %}, Map<String, String> topicTemplateValues, int qos) throws {% if message_body_type != "byte[]" %}Exception{% else %}MqttException{% endif %} {
        String topicPattern = topicMappings.getOrDefault("{{ messageid }}", "{{ default_topic }}");
        
        // Merge explicit parameters with topicTemplateValues
        Map<String, String> allTemplateValues = new HashMap<>();
        if (topicTemplateValues != null) {
            allTemplateValues.putAll(topicTemplateValues);
        }
        {%- for var in topic_template_vars %}
        if ({{ var }} != null && !{{ var }}.isEmpty()) {
            allTemplateValues.put("{{ var }}", {{ var }});
        }
        {%- endfor %}
        
        String topic = applyTopicTemplate(topicPattern, allTemplateValues);
        
        {%- if message_body_type == "byte[]" %}
        byte[] payload = data;
        {%- else %}
        byte[] payload = data.toByteArray("application/json");
        {%- endif %}
        MqttMessage message = new MqttMessage(payload);
        message.setQos(qos);
        mqttClient.publish(topic, message);
        logger.debug("Published {{ messagename }} to topic {}", topic);
    }

    /**
     * Send {{ messagename }} message with QoS 1 and no explicit template values.
     * 
     * @param data The message data to send
     {%- for var in topic_template_vars %}
     * @param {{ var }} Topic template placeholder value
     {%- endfor %}
     * @throws MqttException if publishing fails
     {%- if message_body_type != "byte[]" %}
     * @throws Exception if serialization fails
     {%- endif %}
     */
    public void send{{ messagename }}({{ message_body_type }} data{%- for var in topic_template_vars %}, String {{ var }}{%- endfor %}) throws {% if message_body_type != "byte[]" %}Exception{% else %}MqttException{% endif %} {
        send{{ messagename }}(data{%- for var in topic_template_vars %}, {{ var }}{%- endfor %}, null, 1);
    }

    /**
     * Send {{ messagename }} message with QoS 1.
     * 
     * @param data The message data to send
     {%- for var in topic_template_vars %}
     * @param {{ var }} Topic template placeholder value
     {%- endfor %}
     * @param topicTemplateValues Optional additional topic template values
     * @throws MqttException if publishing fails
     {%- if message_body_type != "byte[]" %}
     * @throws Exception if serialization fails
     {%- endif %}
     */
    public void send{{ messagename }}({{ message_body_type }} data{%- for var in topic_template_vars %}, String {{ var }}{%- endfor %}, Map<String, String> topicTemplateValues) throws {% if message_body_type != "byte[]" %}Exception{% else %}MqttException{% endif %} {
        send{{ messagename }}(data{%- for var in topic_template_vars %}, {{ var }}{%- endfor %}, topicTemplateValues, 1);
    }
    {%- endfor %}

    @Override
    public void close() {
        try {
            if (mqttClient != null && mqttClient.isConnected()) {
                mqttClient.disconnect();
                mqttClient.close();
            }
        } catch (MqttException e) {
            logger.error("Error closing producer", e);
        }
    }
}
{% endfor %}
