name: Publish to VS Code Marketplace

on:
  push:
    tags:
      - 'v*'
  workflow_run:
    workflows: ["Python Test"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Force publish even without tag'
        required: false
        default: 'false'

jobs:
  publish-vscode:
    runs-on: ubuntu-latest
    # Only run if tests passed (or triggered by tag/manual dispatch)
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Full history for version detection

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'

    - name: Extract version from tag
      id: get_version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "has_tag=true" >> $GITHUB_OUTPUT
        else
          echo "has_tag=false" >> $GITHUB_OUTPUT
        fi

    - name: Check if VSCE_PAT secret is available
      id: check_secret
      run: |
        if [ -n "${{ secrets.VSCE_PAT }}" ]; then
          echo "secret_available=true" >> $GITHUB_OUTPUT
        else
          echo "secret_available=false" >> $GITHUB_OUTPUT
        fi

    - name: Install vsce
      run: npm install -g @vscode/vsce

    - name: Update extension version
      if: steps.get_version.outputs.has_tag == 'true'
      working-directory: ./xrcg_vscode
      run: |
        npm --no-git-tag-version version ${{ steps.get_version.outputs.version }}

    - name: Install extension dependencies
      working-directory: ./xrcg_vscode
      run: npm install

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Validate package.json for duplicates
      run: python tools/validate_vscode_package.py --package-json xrcg_vscode/package.json

    - name: Build extension
      working-directory: ./xrcg_vscode
      run: |
        npm run esbuild
        vsce package

    - name: Display extension information
      working-directory: ./xrcg_vscode
      run: |
        echo "üì¶ Built VS Code extension:"
        ls -lh *.vsix
        echo ""
        echo "Extension package created successfully"

    - name: Publish to VS Code Marketplace
      if: steps.check_secret.outputs.secret_available == 'true' && (steps.get_version.outputs.has_tag == 'true' || github.event.inputs.force_publish == 'true')
      working-directory: ./xrcg_vscode
      run: |
        vsce publish -p ${{ secrets.VSCE_PAT }}
      env:
        VSCE_PAT: ${{ secrets.VSCE_PAT }}

    - name: Skip publishing (no secret or no tag)
      if: steps.check_secret.outputs.secret_available == 'false' || (steps.get_version.outputs.has_tag == 'false' && github.event.inputs.force_publish != 'true')
      run: |
        echo "‚ö†Ô∏è  Skipping VS Code Marketplace publish:"
        if [ "${{ steps.check_secret.outputs.secret_available }}" == "false" ]; then
          echo "   - VSCE_PAT secret is not configured"
          echo "   - To publish to VS Code Marketplace, add the VSCE_PAT secret to the repository"
          echo "   - Get your Personal Access Token from https://dev.azure.com"
          echo "   - Follow instructions at https://code.visualstudio.com/api/working-with-extensions/publishing-extension"
        fi
        if [ "${{ steps.get_version.outputs.has_tag }}" == "false" ]; then
          echo "   - Not triggered by a version tag"
        fi
        echo ""
        echo "üì¶ Extension packaged successfully and available as artifact"

    - name: Upload extension artifact
      uses: actions/upload-artifact@v5
      with:
        name: vscode-extension
        path: xrcg_vscode/*.vsix
        retention-days: 30
