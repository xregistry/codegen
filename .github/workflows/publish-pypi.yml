name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'
  workflow_run:
    workflows: ["Python Test"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Force publish even without tag'
        required: false
        default: 'false'

jobs:
  publish-pypi:
    runs-on: ubuntu-latest
    # Only run if tests passed (or triggered by tag/manual dispatch)
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    permissions:
      contents: read
      id-token: write  # Required for trusted publishing
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Full history for version detection
        ref: ${{ github.ref }}  # Explicitly checkout the ref (tag or branch)

    - name: Verify git state for version
      run: |
        echo "Git ref: ${{ github.ref }}"
        echo "Git SHA: ${{ github.sha }}"
        echo "Current HEAD:"
        git log -1 --oneline
        echo "Tags at HEAD:"
        git tag --points-at HEAD || echo "No tags at HEAD"
        echo "Git describe:"
        git describe --tags --always

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install build wheel flit-scm setuptools-scm

    - name: Extract version from tag
      id: get_version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "has_tag=true" >> $GITHUB_OUTPUT
          echo "üè∑Ô∏è Building from tag: v$VERSION"
        else
          echo "has_tag=false" >> $GITHUB_OUTPUT
          echo "üì¶ Building from branch (dev version)"
        fi

    - name: Verify setuptools_scm version
      run: |
        echo "Version that setuptools_scm will produce:"
        python -c "from setuptools_scm import get_version; print(get_version())"

    - name: Build distribution packages
      env:
        SETUPTOOLS_SCM_PRETEND_VERSION: ${{ steps.get_version.outputs.version }}
      run: |
        # When building from a tag, use SETUPTOOLS_SCM_PRETEND_VERSION to ensure exact version
        if [ "${{ steps.get_version.outputs.has_tag }}" == "true" ]; then
          echo "üè∑Ô∏è Building with version from tag: $SETUPTOOLS_SCM_PRETEND_VERSION"
        fi
        python -m build --sdist --wheel --outdir dist/

    - name: Check if PyPI secret is available
      id: check_secret
      run: |
        if [ -n "${{ secrets.PYPI_API_TOKEN }}" ]; then
          echo "secret_available=true" >> $GITHUB_OUTPUT
        else
          echo "secret_available=false" >> $GITHUB_OUTPUT
        fi

    - name: Display package information
      run: |
        echo "üì¶ Built packages:"
        ls -lh dist/
        echo ""
        echo "Package contents:"
        tar -tzf dist/*.tar.gz | head -20

    - name: Publish to PyPI
      if: steps.check_secret.outputs.secret_available == 'true' && (steps.get_version.outputs.has_tag == 'true' || github.event.inputs.force_publish == 'true')
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        verbose: true

    - name: Publish to Test PyPI (fallback)
      if: steps.check_secret.outputs.secret_available == 'false' || (steps.get_version.outputs.has_tag == 'false' && github.event.inputs.force_publish != 'true')
      run: |
        echo "‚ö†Ô∏è  Skipping PyPI publish:"
        if [ "${{ steps.check_secret.outputs.secret_available }}" == "false" ]; then
          echo "   - PYPI_API_TOKEN secret is not configured"
          echo "   - To publish to PyPI, add the PYPI_API_TOKEN secret to the repository"
          echo "   - Get your token from https://pypi.org/manage/account/token/"
        fi
        if [ "${{ steps.get_version.outputs.has_tag }}" == "false" ]; then
          echo "   - Not triggered by a version tag"
        fi
        echo ""
        echo "üì¶ Packages built successfully and available as artifacts"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-packages
        path: dist/
        retention-days: 30
