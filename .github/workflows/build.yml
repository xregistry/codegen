name: Python Release
on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.11.1
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -e .
    - id: get_version
      name: Extract version number from tag
      uses: battila7/get-version-action@v2
    - name: Set version environment variable
      run: |
        echo "XRCG_VERSION=${{steps.get_version.outputs.version-without-v}}" > $GITHUB_ENV
    - name: Build Python package
      run: |
        python -m pip install --upgrade pip build wheel
        python -m build --sdist --wheel --outdir dist
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    - name: Validate VSCode extension for duplicate commands
      run: |
        python3 -c "
import json
import sys

with open('xrcg_vscode/package.json', 'r') as f:
    data = json.load(f)

commands = data.get('contributes', {}).get('commands', [])
command_ids = [c.get('command') for c in commands]
duplicates = set([x for x in command_ids if command_ids.count(x) > 1])

if duplicates:
    print(f'ERROR: Duplicate command IDs found: {duplicates}', file=sys.stderr)
    sys.exit(1)

titles = [c.get('title') for c in commands]
dup_titles = set([x for x in titles if titles.count(x) > 1])

if dup_titles:
    print(f'ERROR: Duplicate command titles found: {dup_titles}', file=sys.stderr)
    sys.exit(1)

menus = data.get('contributes', {}).get('menus', {})
for menu_name, items in menus.items():
    menu_cmds = [i.get('command') for i in items if 'command' in i]
    dup_menu = set([x for x in menu_cmds if menu_cmds.count(x) > 1])
    if dup_menu:
        print(f'ERROR: Duplicate menu commands in {menu_name}: {dup_menu}', file=sys.stderr)
        sys.exit(1)

print(f'âœ“ Validated {len(commands)} commands with no duplicates')
"
    - name: Build VSCode extension
      run: |
        npm install -g @vscode/vsce
        cd xrcg_vscode      
        npm --no-git-tag-version version ${{steps.get_version.outputs.version-without-v}}  
        npm install
        vsce package
        mv *.vsix ../dist
        cd ..
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/*.tar.gz
          dist/*.whl
          dist/*.vsix
    
